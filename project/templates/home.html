{% extends 'base.html' %}
{% block title %}drp â€” drop it.{% endblock %}
{% load static %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'css/home.css' %}"/>{% endblock %}

{% block content %}
<div class="home-wrap">

  <!-- Left: Create + Get -->
  <div class="creator">
    <h1>drop it.</h1>
    <p class="tagline">paste text or drop a file. get a key. share the link.</p>

    {% if claimed %}
    <div class="claim-banner">
      âœ“ {{ claimed }} drop{{ claimed|pluralize }} claimed and added to your account.
    </div>
    {% endif %}

    <!-- Tabs -->
    <div class="home-tabs">
      <button class="home-tab active" id="tabSave" onclick="switchTab('save')">save</button>
      <button class="home-tab" id="tabGet" onclick="switchTab('get')">get</button>
    </div>

    <!-- Save panel -->
    <div id="panelSave">
      <div class="key-row">
        <span class="prefix">drp /</span>
        <input type="text" id="keyInput" placeholder="auto-generated (or type your own)" autocomplete="off" spellcheck="false"/>
        <span id="keyStatus"></span>
      </div>

      <div class="content-area">
        <textarea id="textInput" placeholder="paste text, code, linksâ€¦" rows="6"></textarea>
        <div class="or-divider">or</div>
        <div class="drop-zone" id="dropZone">
          <span id="dropLabel">drag & drop a file or <label for="fileInput" class="link">browse</label></span>
          <input type="file" id="fileInput" hidden/>
        </div>
        <div id="filePreview" class="file-preview hidden"></div>
      </div>

      <!-- Upload progress bar -->
      <div id="progressWrap" class="hidden" style="margin:.6rem 0">
        <div style="display:flex;justify-content:space-between;font-size:.78rem;color:var(--muted);margin-bottom:.25rem">
          <span id="progressLabel">uploadingâ€¦</span>
          <span id="progressPct">0%</span>
        </div>
        <div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden">
          <div id="progressBar" style="height:100%;width:0;background:var(--accent);border-radius:2px;transition:width .1s linear"></div>
        </div>
        <div id="progressSpeed" style="font-size:.75rem;color:var(--muted);margin-top:.2rem"></div>
      </div>

      {% if user.is_authenticated and user.profile.is_paid %}
      <div class="expiry-row">
        <label for="expiryDays">expires in</label>
        <select id="expiryDays">
          <option value="7">7 days</option>
          <option value="30">30 days</option>
          <option value="90" selected>90 days</option>
          <option value="180">180 days</option>
          {% if user.profile.plan == 'starter' %}
          <option value="365">1 year</option>
          {% endif %}
          {% if user.profile.plan == 'pro' %}
          <option value="365">1 year</option>
          <option value="730">2 years</option>
          <option value="1095">3 years</option>
          {% endif %}
        </select>
        <span class="muted" style="font-size:.8rem">from creation Â· renewable</span>
      </div>
      {% endif %}

      <button class="btn" id="saveBtn">save & get link</button>
      <p id="errorMsg" class="error hidden"></p>

      <div id="resultBox" class="result-box hidden">
        <span class="muted">your link:</span>
        <a id="resultUrl" href="#" target="_blank"></a>
        <button class="btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('resultUrl').href); showToast('copied!')">copy</button>
      </div>

      {% if not user.is_authenticated %}
      <p id="anonNudge" class="anon-nudge hidden">
        Drop expires in 7 days. <a href="/auth/register/">Sign up free</a> to claim it and extend to 30 days.
      </p>
      {% endif %}
    </div>

    <!-- Get panel -->
    <div id="panelGet" class="hidden">
      <div class="key-row">
        <span class="prefix">drp /</span>
        <input type="text" id="getKeyInput" placeholder="enter keyâ€¦"
               autocomplete="off" spellcheck="false"/>
      </div>
      <div style="display:flex;gap:.5rem;margin-bottom:.8rem">
        <button class="btn-sm" id="getBtn">get clip</button>
        <button class="btn-sm" id="getFileBtn">get file</button>
      </div>
      <p id="getError" class="error hidden"></p>

      <!-- Text drop result -->
      <div id="getResult" class="clip-existing hidden">
        <pre id="getContent" style="white-space:pre-wrap;word-break:break-all;font-size:.88rem;font-family:monospace"></pre>
        <div class="clip-actions" style="margin-top:.7rem">
          <button class="btn-sm" onclick="copyGetContent()">copy text</button>
          <button class="btn-sm" id="openDropBtn">open page</button>
        </div>
      </div>

      <!-- File drop result -->
      <div id="getFileResult" class="file-card big hidden" style="margin-top:.8rem">
        <span class="file-icon">ðŸ“Ž</span>
        <div>
          <div class="fname" id="getFileName"></div>
          <div class="fsize muted" id="getFileSize"></div>
        </div>
        <a id="getFileLink" href="#" class="btn">â†“ download</a>
      </div>
    </div>
  </div>

  <!-- Right: Dashboard -->
  <div class="dashboard">
    {% if user.is_authenticated %}
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.4rem">
        <h3 style="margin-bottom:0">my drops</h3>
        <div style="display:flex;gap:.4rem">
          <a href="/auth/account/export/" class="btn-sm">â†“ export</a>
          <label for="importInput" class="btn-sm" style="cursor:pointer">â†‘ import</label>
          <input type="file" id="importInput" accept=".json" hidden/>
        </div>
      </div>
      <div class="drop-list" id="myDrops">
        {% if server_drops %}
          {% for drop in server_drops %}
          <div class="drop-item">
            <span class="drop-icon">{% if drop.kind == 'file' %}ðŸ“Ž{% else %}ðŸ“‹{% endif %}</span>
            <a href="{% if drop.ns == 'f' %}/f/{{ drop.key }}/{% else %}/{{ drop.key }}/{% endif %}" class="drop-key">{% if drop.ns == 'f' %}f/{% endif %}{{ drop.key }}</a>
            <span class="drop-label muted">
              {% if drop.kind == 'file' %}{{ drop.filename|truncatechars:20 }}{% else %}{{ drop.content|truncatechars:20 }}{% endif %}
            </span>
            {% if drop.expires_at %}
            <span class="drop-expiry muted">{{ drop.expires_at|date:"M j" }}</span>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <p class="empty muted">nothing yet.</p>
        {% endif %}
      </div>

      {% if saved_drops %}
      <h3 style="margin-top:1.2rem;margin-bottom:.4rem">saved</h3>
      <div class="drop-list">
        {% for s in saved_drops %}
        <div class="drop-item">
          <span class="drop-icon">ðŸ”–</span>
          <a href="{{ s.url_path }}" class="drop-key">{% if s.ns == 'f' %}f/{% endif %}{{ s.key }}</a>
          <span class="drop-label muted">{{ s.saved_at|date:"M j" }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      {% if user.profile.is_paid %}
      <div class="storage-bar-wrap" style="margin-top:.8rem">
        <div class="storage-label muted">
          {{ user.profile.storage_used_gb|floatformat:2 }} GB
          / {{ user.profile.storage_quota_gb }} GB used
        </div>
        <div class="storage-bar">
          <div class="storage-bar-fill" style="width:{% widthratio user.profile.storage_used_bytes user.profile.storage_quota_bytes 100 %}%"></div>
        </div>
      </div>
      {% endif %}

    {% else %}
      <h3>my drops</h3>
      <div id="myDrops" class="drop-list">
        <p class="empty muted" id="anonEmpty">nothing yet.</p>
      </div>
      <div class="dashboard-actions" id="anonActions" style="display:none">
        <button class="btn-sm" id="exportBtn">â†“ export</button>
        <button class="btn-sm danger" id="clearAll">clear all</button>
      </div>

      <div class="anon-upsell">
        <p class="upsell-heading">free account unlocks:</p>
        <ul class="upsell-list">
          <li>âœ“ claim &amp; keep drops you create</li>
          <li>âœ“ 48h idle timeout (vs 24h)</li>
          <li>âœ“ 30-day max lifetime (vs 7d)</li>
          <li>âœ“ save &amp; bookmark others' drops</li>
          <li>âœ“ export &amp; import collections</li>
        </ul>
        <div style="display:flex;gap:.5rem;margin-top:.6rem;flex-wrap:wrap">
          <a href="/auth/register/" class="btn" style="font-size:.82rem;padding:.4rem .9rem">sign up free</a>
          <a href="/auth/login/" class="btn-sm">log in</a>
        </div>
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
const IS_AUTHED = {{ user.is_authenticated|yesno:"true,false" }};
const IS_PAID   = {{ user.is_authenticated|yesno:"true,false" }}
                  && {{ user.profile.is_paid|default:"false"|yesno:"true,false" }};

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.getElementById('panelSave').classList.toggle('hidden', tab !== 'save');
  document.getElementById('panelGet').classList.toggle('hidden', tab !== 'get');
  document.getElementById('tabSave').classList.toggle('active', tab === 'save');
  document.getElementById('tabGet').classList.toggle('active', tab === 'get');
  if (tab === 'get') document.getElementById('getKeyInput').focus();
}

// â”€â”€ Get drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _currentGetKey = '';

async function doGet(isFile) {
  const key    = document.getElementById('getKeyInput').value.trim();
  const errEl  = document.getElementById('getError');
  const resEl  = document.getElementById('getResult');
  const fileEl = document.getElementById('getFileResult');
  errEl.classList.add('hidden');
  resEl.classList.add('hidden');
  fileEl.classList.add('hidden');

  if (!key) {
    errEl.textContent = 'Enter a key first.';
    errEl.classList.remove('hidden');
    return;
  }

  _currentGetKey = key;
  const url = isFile ? `/f/${key}/` : `/${key}/`;

  const btn = isFile ? document.getElementById('getFileBtn') : document.getElementById('getBtn');
  btn.disabled = true;
  const orig = btn.textContent;
  btn.textContent = 'â€¦';

  try {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    const data = await res.json();

    if (!res.ok) {
      errEl.textContent = data.error || `Not found (${res.status}).`;
      errEl.classList.remove('hidden');
      return;
    }

    if (data.kind === 'text') {
      document.getElementById('getContent').textContent = data.content;
      document.getElementById('openDropBtn').onclick = () => window.open(`/${key}/`, '_blank');
      resEl.classList.remove('hidden');
    } else if (data.kind === 'file') {
      document.getElementById('getFileName').textContent = data.filename || key;
      document.getElementById('getFileSize').textContent =
        data.filesize ? formatSize(data.filesize) : '';
      document.getElementById('getFileLink').href = `/f/${key}/download/`;
      fileEl.classList.remove('hidden');
    } else {
      if (!isFile) {
        errEl.textContent = `/${key}/ is a file drop. Use "get file" instead.`;
      } else {
        errEl.textContent = `/f/${key}/ is a clipboard drop. Use "get clip" instead.`;
      }
      errEl.classList.remove('hidden');
    }
  } catch (e) {
    errEl.textContent = 'Network error.';
    errEl.classList.remove('hidden');
  } finally {
    btn.disabled = false;
    btn.textContent = orig;
  }
}

function copyGetContent() {
  navigator.clipboard.writeText(document.getElementById('getContent').textContent);
  showToast('copied!');
}

document.getElementById('getBtn').addEventListener('click', () => doGet(false));
document.getElementById('getFileBtn').addEventListener('click', () => doGet(true));
document.getElementById('getKeyInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') doGet(false);
});

// â”€â”€ Import (logged-in) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (IS_AUTHED) {
  const importInput = document.getElementById('importInput');
  if (importInput) {
    importInput.addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (!file) return;
      let data;
      try { data = JSON.parse(await file.text()); } catch { showToast('Invalid JSON file.'); return; }
      const res = await fetch('/auth/account/import/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(data),
      });
      const result = await res.json();
      if (res.ok) {
        showToast(`Imported ${result.imported} drop(s).${result.skipped ? ' ' + result.skipped + ' already saved.' : ''}`);
        if (result.imported > 0) setTimeout(() => location.reload(), 1200);
      } else {
        showToast(result.error || 'Import failed.');
      }
      e.target.value = '';
    });
  }
}

// â”€â”€ Local (anon) drop list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMyDrops() {
  try { return JSON.parse(localStorage.getItem('drp_drops') || '[]'); } catch { return []; }
}
function saveMyDrops(drops) { localStorage.setItem('drp_drops', JSON.stringify(drops)); }
function addDropLocal(key, kind, label) {
  const drops = getMyDrops().filter(d => d.key !== key);
  drops.unshift({ key, kind, label, saved: Date.now() });
  saveMyDrops(drops.slice(0, 50));
  renderLocalDashboard();
}
function removeDrop(key) {
  saveMyDrops(getMyDrops().filter(d => d.key !== key));
  renderLocalDashboard();
}

function renderLocalDashboard() {
  if (IS_AUTHED) return;
  const drops    = getMyDrops();
  const el       = document.getElementById('myDrops');
  const emptyEl  = document.getElementById('anonEmpty');
  const actionsEl = document.getElementById('anonActions');
  if (!drops.length) {
    el.innerHTML = '';
    if (emptyEl)   { emptyEl.style.display = ''; el.appendChild(emptyEl); }
    if (actionsEl)   actionsEl.style.display = 'none';
    return;
  }
  if (emptyEl)   emptyEl.style.display = 'none';
  if (actionsEl) actionsEl.style.display = '';
  el.innerHTML = drops.map(d => `
    <div class="drop-item">
      <span class="drop-icon">${d.kind === 'file' ? 'ðŸ“Ž' : 'ðŸ“‹'}</span>
      <a href="/${d.key}/" class="drop-key">${d.key}</a>
      <span class="drop-label muted">${d.label || ''}</span>
      <button class="btn-sm danger" onclick="removeDrop('${d.key}')">âœ•</button>
    </div>
  `).join('');
}

if (!IS_AUTHED) {
  renderLocalDashboard();

  document.getElementById('clearAll').addEventListener('click', () => {
    if (!confirm('Clear local list? Drops on the server are not affected.')) return;
    localStorage.removeItem('drp_drops');
    renderLocalDashboard();
  });

  document.getElementById('exportBtn').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify({version:1, exported: new Date().toISOString(), drops: getMyDrops()}, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `drp-dashboard-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    showToast('exported!');
  });
}

// â”€â”€ Key availability check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let keyTimer = null;
const keyInput  = document.getElementById('keyInput');
const keyStatus = document.getElementById('keyStatus');

keyInput.addEventListener('input', () => {
  clearTimeout(keyTimer);
  const val = keyInput.value.trim();
  if (!val) { keyStatus.textContent = ''; return; }
  keyTimer = setTimeout(async () => {
    const res  = await fetch(`/check-key/?key=${encodeURIComponent(val)}`);
    const data = await res.json();
    keyStatus.textContent = data.available ? 'âœ“' : 'âœ— taken';
    keyStatus.className   = data.available ? 'ok' : 'taken';
  }, 400);
});

// â”€â”€ File selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedFile = null;
const dropZone   = document.getElementById('dropZone');
const fileInput  = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const textInput  = document.getElementById('textInput');

dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); setFile(e.dataTransfer.files[0]); });
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => setFile(fileInput.files[0]));

function setFile(f) {
  if (!f) return;
  selectedFile = f;
  textInput.value    = '';
  textInput.disabled = true;
  filePreview.classList.remove('hidden');
  filePreview.innerHTML = `<span>ðŸ“Ž ${f.name} (${formatSize(f.size)})</span> <button class="btn-sm danger" onclick="clearFile()">âœ•</button>`;
  dropZone.classList.add('has-file');
  document.getElementById('dropLabel').textContent = 'click to change file';
}

function clearFile() {
  selectedFile       = null;
  fileInput.value    = '';
  textInput.disabled = false;
  filePreview.classList.add('hidden');
  dropZone.classList.remove('has-file');
  document.getElementById('dropLabel').innerHTML =
    'drag & drop a file or <label for="fileInput" class="link">browse</label>';
}

// â”€â”€ Progress bar helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _uploadStart = 0;

function showProgress() {
  document.getElementById('progressWrap').classList.remove('hidden');
  _uploadStart = performance.now();
}
function hideProgress() {
  document.getElementById('progressWrap').classList.add('hidden');
}
function updateProgress(loaded, total) {
  const pct     = total > 0 ? Math.round((loaded / total) * 100) : 0;
  const elapsed = (performance.now() - _uploadStart) / 1000;
  const speed   = elapsed > 0.1 ? loaded / elapsed : 0;
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressPct').textContent = pct + '%';
  document.getElementById('progressLabel').textContent = pct < 100 ? 'uploadingâ€¦' : 'confirmingâ€¦';
  document.getElementById('progressSpeed').textContent =
    speed > 0 ? `${formatSize(speed)}/s  Â·  ${formatSize(loaded)} / ${formatSize(total)}` : '';
}

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('saveBtn').addEventListener('click', async () => {
  const key    = keyInput.value.trim();
  const text   = textInput.value.trim();
  const errEl  = document.getElementById('errorMsg');
  const saveBtn = document.getElementById('saveBtn');
  errEl.classList.add('hidden');

  if (!text && !selectedFile) {
    errEl.textContent = 'Add some text or a file first.';
    errEl.classList.remove('hidden');
    return;
  }

  saveBtn.disabled    = true;
  saveBtn.textContent = 'savingâ€¦';

  const fd = new FormData();
  if (key) fd.append('key', key);
  const expiryEl = document.getElementById('expiryDays');
  if (expiryEl) fd.append('expiry_days', expiryEl.value);

  if (selectedFile) {
    fd.append('file', selectedFile);
    showProgress();
  } else {
    fd.append('content', text);
  }

  const xhr = new XMLHttpRequest();
  xhr.open('POST', '/save/');
  xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

  xhr.upload.addEventListener('progress', e => {
    if (e.lengthComputable) updateProgress(e.loaded, e.total);
  });

  xhr.addEventListener('load', () => {
    hideProgress();
    try {
      const data = JSON.parse(xhr.responseText);
      if (xhr.status === 200) {
        if (!IS_AUTHED) {
          addDropLocal(data.key, data.kind,
            selectedFile ? selectedFile.name : text.slice(0, 30));
          const nudge = document.getElementById('anonNudge');
          if (nudge) nudge.classList.remove('hidden');
        } else {
          window.location.reload();
          return;
        }
        const base = data.ns === 'f' ? `/f/${data.key}/` : `/${data.key}/`;
        document.getElementById('resultUrl').href        = window.location.origin + base;
        document.getElementById('resultUrl').textContent = window.location.origin + base;
        document.getElementById('resultBox').classList.remove('hidden');
        textInput.value    = '';
        textInput.disabled = false;
        keyInput.value     = '';
        keyStatus.textContent = '';
        clearFile();
        saveBtn.disabled    = false;
        saveBtn.textContent = 'save & get link';
        showToast('drop created!');
      } else {
        errEl.textContent = data.error || 'Something went wrong.';
        errEl.classList.remove('hidden');
        saveBtn.disabled    = false;
        saveBtn.textContent = 'save & get link';
      }
    } catch {
      errEl.textContent = 'Unexpected error.';
      errEl.classList.remove('hidden');
      saveBtn.disabled    = false;
      saveBtn.textContent = 'save & get link';
    }
  });

  xhr.addEventListener('error', () => {
    hideProgress();
    errEl.textContent = 'Network error.';
    errEl.classList.remove('hidden');
    saveBtn.disabled    = false;
    saveBtn.textContent = 'save & get link';
  });

  xhr.send(fd);
});
</script>
{% endblock %}