{% extends 'base.html' %}
{% block title %}drp â€” drop it.{% endblock %}

{% block content %}
<div class="home-wrap">

  <!-- Left: Create -->
  <div class="creator">
    <h1>drop it.</h1>
    <p class="tagline">paste text or drop a file. get a key. share the link.</p>

    <div class="key-row">
      <span class="prefix">drp /</span>
      <input type="text" id="keyInput" placeholder="auto-generated (or type your own)" autocomplete="off" spellcheck="false"/>
      <span id="keyStatus"></span>
    </div>

    <div class="content-area">
      <textarea id="textInput" placeholder="paste text, code, linksâ€¦" rows="6"></textarea>
      <div class="or-divider">or</div>
      <div class="drop-zone" id="dropZone">
        <span id="dropLabel">drag & drop a file or <label for="fileInput" class="link">browse</label></span>
        <input type="file" id="fileInput" hidden/>
      </div>
      <div id="filePreview" class="file-preview hidden"></div>
    </div>

    <button class="btn" id="saveBtn">save & get link</button>
    <p id="errorMsg" class="error hidden"></p>

    <div id="resultBox" class="result-box hidden">
      <span class="muted">your link:</span>
      <a id="resultUrl" href="#" target="_blank"></a>
      <button class="btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('resultUrl').href); showToast('copied!')">copy</button>
    </div>
  </div>

  <!-- Right: My drops (localStorage) -->
  <div class="dashboard">
    <h3>my drops</h3>
    <div id="myDrops" class="drop-list">
      <p class="empty muted">nothing yet.</p>
    </div>
    <div class="dashboard-actions">
      <button class="btn-sm" id="exportBtn" style="display:none">â†“ export</button>
      <label for="importInput" class="btn-sm" id="importLabel" style="display:none;cursor:pointer">â†‘ import</label>
      <input type="file" id="importInput" accept=".json" hidden/>
      <button class="btn-sm danger" id="clearAll" style="display:none">clear all</button>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// â”€â”€ Storage helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMyDrops() {
  try { return JSON.parse(localStorage.getItem('drp_drops') || '[]'); } catch { return []; }
}
function saveMyDrops(drops) {
  localStorage.setItem('drp_drops', JSON.stringify(drops));
}
function addDrop(key, kind, label) {
  const drops = getMyDrops().filter(d => d.key !== key);
  drops.unshift({ key, kind, label, saved: Date.now() });
  saveMyDrops(drops.slice(0, 50));
  renderDashboard();
}
function removeDrop(key) {
  saveMyDrops(getMyDrops().filter(d => d.key !== key));
  renderDashboard();
}

function renderDashboard() {
  const drops = getMyDrops();
  const el = document.getElementById('myDrops');
  const clearBtn = document.getElementById('clearAll');
  const exportBtn = document.getElementById('exportBtn');
  const importLabel = document.getElementById('importLabel');
  
  if (!drops.length) {
    el.innerHTML = '<p class="empty muted">nothing yet.</p>';
    clearBtn.style.display = 'none';
    exportBtn.style.display = 'none';
    importLabel.style.display = '';
    return;
  }
  
  clearBtn.style.display = '';
  exportBtn.style.display = '';
  importLabel.style.display = '';
  
  el.innerHTML = drops.map(d => `
    <div class="drop-item">
      <span class="drop-icon">${d.kind === 'file' ? 'ðŸ“Ž' : 'ðŸ“‹'}</span>
      <a href="/${d.key}/" class="drop-key">${d.key}</a>
      <span class="drop-label muted">${d.label || ''}</span>
      <button class="btn-sm danger" onclick="removeDrop('${d.key}')">âœ•</button>
    </div>
  `).join('');
}

document.getElementById('clearAll').addEventListener('click', () => {
  if (!confirm('Clear all drops from your dashboard? This only removes them from your local list, not from the server.')) return;
  localStorage.removeItem('drp_drops');
  renderDashboard();
});

// â”€â”€ Export dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('exportBtn').addEventListener('click', () => {
  const drops = getMyDrops();
  const data = {
    version: 1,
    exported: new Date().toISOString(),
    drops: drops
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `drp-dashboard-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  showToast('dashboard exported!');
});

// â”€â”€ Import dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('importInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!data.drops || !Array.isArray(data.drops)) {
        showToast('Invalid dashboard file');
        return;
      }
      
      // Merge with existing drops (keep newer ones)
      const existing = getMyDrops();
      const existingKeys = new Set(existing.map(d => d.key));
      const newDrops = data.drops.filter(d => !existingKeys.has(d.key));
      
      saveMyDrops([...existing, ...newDrops]);
      renderDashboard();
      showToast(`imported ${newDrops.length} drops!`);
    } catch (err) {
      showToast('Failed to import dashboard');
      console.error(err);
    }
  };
  reader.readAsText(file);
  e.target.value = ''; // Reset input
});

renderDashboard();

// â”€â”€ Key check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let keyTimer = null;
const keyInput = document.getElementById('keyInput');
const keyStatus = document.getElementById('keyStatus');

keyInput.addEventListener('input', () => {
  clearTimeout(keyTimer);
  const val = keyInput.value.trim();
  if (!val) { keyStatus.textContent = ''; return; }
  keyTimer = setTimeout(async () => {
    const res = await fetch(`/check-key/?key=${encodeURIComponent(val)}`);
    const data = await res.json();
    keyStatus.textContent = data.available ? 'âœ“' : 'âœ— taken';
    keyStatus.className = data.available ? 'ok' : 'taken';
  }, 400);
});

// â”€â”€ File select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedFile = null;
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const textInput = document.getElementById('textInput');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); setFile(e.dataTransfer.files[0]); });
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => setFile(fileInput.files[0]));

function setFile(f) {
  if (!f) return;
  selectedFile = f;
  textInput.value = '';
  textInput.disabled = true;
  filePreview.classList.remove('hidden');
  filePreview.innerHTML = `<span>ðŸ“Ž ${f.name} (${formatSize(f.size)})</span> <button class="btn-sm danger" onclick="clearFile()">âœ•</button>`;
  dropZone.classList.add('has-file');
  document.getElementById('dropLabel').textContent = 'click to change file';
}

function clearFile() {
  selectedFile = null;
  fileInput.value = '';
  textInput.disabled = false;
  filePreview.classList.add('hidden');
  dropZone.classList.remove('has-file');
  document.getElementById('dropLabel').innerHTML = 'drag & drop a file or <label for="fileInput" class="link">browse</label>';
}

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('saveBtn').addEventListener('click', async () => {
  const key = keyInput.value.trim();
  const text = textInput.value.trim();
  const errEl = document.getElementById('errorMsg');
  errEl.classList.add('hidden');

  if (!text && !selectedFile) {
    errEl.textContent = 'Add some text or a file first.';
    errEl.classList.remove('hidden');
    return;
  }

  const fd = new FormData();
  if (key) fd.append('key', key);

  if (selectedFile) {
    fd.append('file', selectedFile);
  } else {
    fd.append('content', text);
  }

  const saveBtn = document.getElementById('saveBtn');
  saveBtn.disabled = true;
  saveBtn.textContent = 'savingâ€¦';

  const xhr = new XMLHttpRequest();
  xhr.open('POST', '/save/');
  xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

  xhr.upload.addEventListener('progress', e => {
    if (e.lengthComputable) {
      const pct = Math.round((e.loaded / e.total) * 100);
      saveBtn.textContent = pct < 100 ? `uploadingâ€¦ ${pct}%` : 'savingâ€¦';
    }
  });

  xhr.addEventListener('load', () => {
    try {
      const data = JSON.parse(xhr.responseText);
      if (xhr.status === 200) {
        addDrop(data.key, data.kind, selectedFile ? selectedFile.name : text.slice(0, 30));
        
        // Show result box instead of redirecting
        document.getElementById('resultUrl').href = window.location.origin + '/' + data.key + '/';
        document.getElementById('resultUrl').textContent = window.location.origin + '/' + data.key + '/';
        document.getElementById('resultBox').classList.remove('hidden');
        
        // Clear form
        textInput.value = '';
        textInput.disabled = false;
        keyInput.value = '';
        keyStatus.textContent = '';
        clearFile();
        
        // Reset button
        saveBtn.disabled = false;
        saveBtn.textContent = 'save & get link';
        
        showToast('drop created!');
      } else {
        errEl.textContent = data.error || 'Something went wrong.';
        errEl.classList.remove('hidden');
        saveBtn.disabled = false;
        saveBtn.textContent = 'save & get link';
      }
    } catch {
      errEl.textContent = 'Unexpected error.';
      errEl.classList.remove('hidden');
      saveBtn.disabled = false;
      saveBtn.textContent = 'save & get link';
    }
  });

  xhr.addEventListener('error', () => {
    errEl.textContent = 'Network error.';
    errEl.classList.remove('hidden');
    saveBtn.disabled = false;
    saveBtn.textContent = 'save & get link';
  });

  xhr.send(fd);
});
</script>
{% endblock %}