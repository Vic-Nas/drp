{% extends 'base.html' %}
{% block title %}drp â€” drop it.{% endblock %}

{% block content %}
<div class="home-wrap">

  <!-- Left: Create -->
  <div class="creator">
    <h1>drop it.</h1>
    <p class="tagline">paste text or drop a file. get a key. share the link.</p>

    {% if claimed %}
    <div class="claim-banner">
      âœ“ {{ claimed }} drop{{ claimed|pluralize }} claimed and added to your account.
    </div>
    {% endif %}

    <div class="key-row">
      <span class="prefix">drp /</span>
      <input type="text" id="keyInput" placeholder="auto-generated (or type your own)" autocomplete="off" spellcheck="false"/>
      <span id="keyStatus"></span>
    </div>

    <div class="content-area">
      <textarea id="textInput" placeholder="paste text, code, linksâ€¦" rows="6"></textarea>
      <div class="or-divider">or</div>
      <div class="drop-zone" id="dropZone">
        <span id="dropLabel">drag & drop a file or <label for="fileInput" class="link">browse</label></span>
        <input type="file" id="fileInput" hidden/>
      </div>
      <div id="filePreview" class="file-preview hidden"></div>
    </div>

    {% if user.is_authenticated and user.profile.is_paid %}
    <div class="expiry-row">
      <label for="expiryDays">expires in</label>
      <select id="expiryDays">
        <option value="7">7 days</option>
        <option value="30">30 days</option>
        <option value="90" selected>90 days</option>
        <option value="180">180 days</option>
        {% if user.profile.plan == 'starter' %}
        <option value="365">1 year</option>
        {% endif %}
        {% if user.profile.plan == 'pro' %}
        <option value="365">1 year</option>
        <option value="730">2 years</option>
        <option value="1095">3 years</option>
        {% endif %}
      </select>
      <span class="muted" style="font-size:.8rem">from creation Â· renewable</span>
    </div>
    {% endif %}

    <button class="btn" id="saveBtn">save & get link</button>
    <p id="errorMsg" class="error hidden"></p>

    <div id="resultBox" class="result-box hidden">
      <span class="muted">your link:</span>
      <a id="resultUrl" href="#" target="_blank"></a>
      <button class="btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('resultUrl').href); showToast('copied!')">copy</button>
    </div>

    {% if not user.is_authenticated %}
    <p id="anonNudge" class="anon-nudge hidden">
      Drop expires in 7 days. <a href="/auth/register/">Sign up free</a> to claim it and extend to 30 days.
    </p>
    {% endif %}
  </div>

  <!-- Right: Dashboard -->
  <div class="dashboard">
    {% if user.is_authenticated %}
      <h3>my drops</h3>
      <div class="drop-list" id="myDrops">
        {% if server_drops %}
          {% for drop in server_drops %}
          <div class="drop-item">
            <span class="drop-icon">{% if drop.kind == 'file' %}ðŸ“Ž{% else %}ðŸ“‹{% endif %}</span>
            <a href="{% if drop.ns == 'f' %}/f/{{ drop.key }}/{% else %}/{{ drop.key }}/{% endif %}" class="drop-key">{% if drop.ns == 'f' %}f/{% endif %}{{ drop.key }}</a>
            <span class="drop-label muted">
              {% if drop.kind == 'file' %}{{ drop.filename|truncatechars:20 }}{% else %}{{ drop.content|truncatechars:20 }}{% endif %}
            </span>
            {% if drop.expires_at %}
            <span class="drop-expiry muted">{{ drop.expires_at|date:"M j" }}</span>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <p class="empty muted">nothing yet.</p>
        {% endif %}
      </div>
      {% if user.profile.is_paid %}
      <div class="storage-bar-wrap" style="margin-top:.8rem">
        <div class="storage-label muted">
          {{ user.profile.storage_used_gb|floatformat:2 }} GB
          / {{ user.profile.storage_quota_gb }} GB used
        </div>
        <div class="storage-bar">
          <div class="storage-bar-fill" style="width:{% widthratio user.profile.storage_used_bytes user.profile.storage_quota_bytes 100 %}%"></div>
        </div>
      </div>
      {% endif %}

    {% else %}
      <h3>my drops</h3>
      <div id="myDrops" class="drop-list">
        <p class="empty muted" id="anonEmpty">nothing yet.</p>
      </div>
      <div class="dashboard-actions" id="anonActions" style="display:none">
        <button class="btn-sm" id="exportBtn">â†“ export</button>
        <button class="btn-sm danger" id="clearAll">clear all</button>
      </div>

      <div class="anon-upsell">
        <p class="upsell-heading">free account unlocks:</p>
        <ul class="upsell-list">
          <li>âœ“ claim &amp; keep drops you create</li>
          <li>âœ“ 48h idle timeout (vs 24h)</li>
          <li>âœ“ 30-day max lifetime (vs 7d)</li>
          <li>âœ“ save &amp; bookmark others' drops</li>
          <li>âœ“ export &amp; import collections</li>
        </ul>
        <div style="display:flex;gap:.5rem;margin-top:.6rem;flex-wrap:wrap">
          <a href="/auth/register/" class="btn" style="font-size:.82rem;padding:.4rem .9rem">sign up free</a>
          <a href="/auth/login/" class="btn-sm">log in</a>
        </div>
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
const IS_AUTHED = {{ user.is_authenticated|yesno:"true,false" }};
const IS_PAID   = {{ user.is_authenticated|yesno:"true,false" }}
                  && {{ user.profile.is_paid|default:"false"|yesno:"true,false" }};

function getMyDrops() {
  try { return JSON.parse(localStorage.getItem('drp_drops') || '[]'); } catch { return []; }
}
function saveMyDrops(drops) { localStorage.setItem('drp_drops', JSON.stringify(drops)); }
function addDropLocal(key, kind, label) {
  const drops = getMyDrops().filter(d => d.key !== key);
  drops.unshift({ key, kind, label, saved: Date.now() });
  saveMyDrops(drops.slice(0, 50));
  renderLocalDashboard();
}
function removeDrop(key) {
  saveMyDrops(getMyDrops().filter(d => d.key !== key));
  renderLocalDashboard();
}

function renderLocalDashboard() {
  if (IS_AUTHED) return;
  const drops = getMyDrops();
  const el = document.getElementById('myDrops');
  const emptyEl = document.getElementById('anonEmpty');
  const actionsEl = document.getElementById('anonActions');
  if (!drops.length) {
    el.innerHTML = '';
    if (emptyEl) { emptyEl.style.display = ''; el.appendChild(emptyEl); }
    if (actionsEl) actionsEl.style.display = 'none';
    return;
  }
  if (emptyEl) emptyEl.style.display = 'none';
  if (actionsEl) actionsEl.style.display = '';
  el.innerHTML = drops.map(d => `
    <div class="drop-item">
      <span class="drop-icon">${d.kind === 'file' ? 'ðŸ“Ž' : 'ðŸ“‹'}</span>
      <a href="/${d.key}/" class="drop-key">${d.key}</a>
      <span class="drop-label muted">${d.label || ''}</span>
      <button class="btn-sm danger" onclick="removeDrop('${d.key}')">âœ•</button>
    </div>
  `).join('');
}

if (!IS_AUTHED) {
  renderLocalDashboard();

  document.getElementById('clearAll').addEventListener('click', () => {
    if (!confirm('Clear local list? Drops on the server are not affected.')) return;
    localStorage.removeItem('drp_drops');
    renderLocalDashboard();
  });

  document.getElementById('exportBtn').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify({version:1, exported: new Date().toISOString(), drops: getMyDrops()}, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `drp-dashboard-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    showToast('exported!');
  });
}

let keyTimer = null;
const keyInput = document.getElementById('keyInput');
const keyStatus = document.getElementById('keyStatus');

keyInput.addEventListener('input', () => {
  clearTimeout(keyTimer);
  const val = keyInput.value.trim();
  if (!val) { keyStatus.textContent = ''; return; }
  keyTimer = setTimeout(async () => {
    const res = await fetch(`/check-key/?key=${encodeURIComponent(val)}`);
    const data = await res.json();
    keyStatus.textContent = data.available ? 'âœ“' : 'âœ— taken';
    keyStatus.className = data.available ? 'ok' : 'taken';
  }, 400);
});

let selectedFile = null;
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const textInput = document.getElementById('textInput');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); setFile(e.dataTransfer.files[0]); });
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => setFile(fileInput.files[0]));

function setFile(f) {
  if (!f) return;
  selectedFile = f;
  textInput.value = '';
  textInput.disabled = true;
  filePreview.classList.remove('hidden');
  filePreview.innerHTML = `<span>ðŸ“Ž ${f.name} (${formatSize(f.size)})</span> <button class="btn-sm danger" onclick="clearFile()">âœ•</button>`;
  dropZone.classList.add('has-file');
  document.getElementById('dropLabel').textContent = 'click to change file';
}

function clearFile() {
  selectedFile = null;
  fileInput.value = '';
  textInput.disabled = false;
  filePreview.classList.add('hidden');
  dropZone.classList.remove('has-file');
  document.getElementById('dropLabel').innerHTML = 'drag & drop a file or <label for="fileInput" class="link">browse</label>';
}

document.getElementById('saveBtn').addEventListener('click', async () => {
  const key = keyInput.value.trim();
  const text = textInput.value.trim();
  const errEl = document.getElementById('errorMsg');
  errEl.classList.add('hidden');

  if (!text && !selectedFile) {
    errEl.textContent = 'Add some text or a file first.';
    errEl.classList.remove('hidden');
    return;
  }

  const fd = new FormData();
  if (key) fd.append('key', key);
  if (selectedFile) { fd.append('file', selectedFile); }
  else { fd.append('content', text); }
  const expiryEl = document.getElementById('expiryDays');
  if (expiryEl) fd.append('expiry_days', expiryEl.value);

  const saveBtn = document.getElementById('saveBtn');
  saveBtn.disabled = true;
  saveBtn.textContent = 'savingâ€¦';

  const xhr = new XMLHttpRequest();
  xhr.open('POST', '/save/');
  xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

  xhr.upload.addEventListener('progress', e => {
    if (e.lengthComputable) {
      const pct = Math.round((e.loaded / e.total) * 100);
      saveBtn.textContent = pct < 100 ? `uploadingâ€¦ ${pct}%` : 'savingâ€¦';
    }
  });

  xhr.addEventListener('load', () => {
    try {
      const data = JSON.parse(xhr.responseText);
      if (xhr.status === 200) {
        if (!IS_AUTHED) {
          addDropLocal(data.key, data.kind, selectedFile ? selectedFile.name : text.slice(0, 30));
          const nudge = document.getElementById('anonNudge');
          if (nudge) nudge.classList.remove('hidden');
        } else {
          window.location.reload();
          return;
        }
        document.getElementById('resultUrl').href = window.location.origin + '/' + data.key + '/';
        document.getElementById('resultUrl').textContent = window.location.origin + '/' + data.key + '/';
        document.getElementById('resultBox').classList.remove('hidden');
        textInput.value = ''; textInput.disabled = false;
        keyInput.value = ''; keyStatus.textContent = '';
        clearFile();
        saveBtn.disabled = false; saveBtn.textContent = 'save & get link';
        showToast('drop created!');
      } else {
        errEl.textContent = data.error || 'Something went wrong.';
        errEl.classList.remove('hidden');
        saveBtn.disabled = false; saveBtn.textContent = 'save & get link';
      }
    } catch {
      errEl.textContent = 'Unexpected error.';
      errEl.classList.remove('hidden');
      saveBtn.disabled = false; saveBtn.textContent = 'save & get link';
    }
  });

  xhr.addEventListener('error', () => {
    errEl.textContent = 'Network error.';
    errEl.classList.remove('hidden');
    saveBtn.disabled = false; saveBtn.textContent = 'save & get link';
  });

  xhr.send(fd);
});
</script>
{% endblock %}