{% extends 'base.html' %}
{% block title %}drp / c / {{ key }}{% endblock %}

{% block content %}

<div class="clip-header">
  <div class="key-row">
    <span class="prefix">drp / c /</span>
    <input type="text" id="keyInput" value="{{ key }}" autocomplete="off" spellcheck="false"/>
    <span id="keyStatus"></span>
  </div>

  <div class="share-url">
    <span id="urlDisplay">{{ request.build_absolute_uri }}</span>
    <button class="btn-sm" onclick="copyUrl()">copy link</button>
  </div>
  <p class="share-hint">share this link — anyone with it can view, paste, or download the content</p>
</div>

<div class="tabs">
  <button class="tab active" id="tabClip" onclick="switchTab('clip')">clipboard</button>
  <button class="tab" id="tabFiles" onclick="switchTab('files')">files</button>
</div>

<!-- Clipboard tab -->
<div id="panelClip">
  {% if clip %}
  <div class="clip-existing">
    <pre id="clipContent">{{ clip.content }}</pre>
    <div class="clip-actions">
      <button class="btn-sm" onclick="copyContent()">copy text</button>
      <a href="#" class="btn-sm" onclick="downloadContent(); return false;">download .txt</a>
      <small class="expiry">clears in 24h</small>
    </div>
  </div>
  {% endif %}

  <form method="post" class="clip-form">
    {% csrf_token %}
    <textarea name="content" placeholder="paste anything here — text, code, links…" rows="8">{% if clip %}{{ clip.content }}{% endif %}</textarea>
    {% if error %}<p class="error">{{ error }}</p>{% endif %}
    <button type="submit" class="btn">save</button>
  </form>
</div>

<!-- Files tab -->
<div id="panelFiles" class="hidden">
  <div class="drop-zone" id="dropZone">
    <span>drag & drop files or <label for="fileInput" class="link">browse</label></span>
    <input type="file" id="fileInput" multiple hidden/>
  </div>
  <div id="fileList" class="file-list hidden"></div>
  <button id="uploadBtn" class="btn" style="margin-top:.8rem" disabled>upload to this key</button>

  {% if bin_files %}
  <div class="file-grid" style="margin-top:1.2rem">
    {% for f in bin_files %}
    <div class="file-card" id="file-{{ f.id }}">
      <span class="fname">{{ f.filename }}</span>
      <span class="fsize">{{ f.size|filesizeformat }}</span>
      <div class="faction">
        <a href="/b/{{ key }}/file/{{ f.id }}/download/" class="btn-sm">↓ download</a>
        <button class="btn-sm danger" onclick="deleteFile({{ f.id }})">✕</button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
const KEY = '{{ key }}';
const BASE = window.location.origin;

function copyUrl() {
  navigator.clipboard.writeText(document.getElementById('urlDisplay').textContent);
  showToast('link copied!');
}

function copyContent() {
  const t = document.getElementById('clipContent');
  if (t) { navigator.clipboard.writeText(t.innerText); showToast('copied!'); }
}

function downloadContent() {
  const text = document.getElementById('clipContent')?.innerText || '';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type: 'text/plain'}));
  a.download = `drp-${KEY}.txt`;
  a.click();
}

// Key input
let keyTimer = null;
const keyInput = document.getElementById('keyInput');
const keyStatus = document.getElementById('keyStatus');

keyInput.addEventListener('input', () => {
  clearTimeout(keyTimer);
  const val = keyInput.value.trim();
  if (!val) return;
  document.getElementById('urlDisplay').textContent = `${BASE}/c/${val}/`;
  keyTimer = setTimeout(async () => {
    const res = await fetch(`/check-key/?key=${encodeURIComponent(val)}`);
    const data = await res.json();
    keyStatus.textContent = data.available ? '✓ free' : '● exists';
    keyStatus.className = 'ok';
  }, 400);
});

keyInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    const val = keyInput.value.trim();
    if (val && val !== KEY) window.location.href = `/c/${val}/`;
  }
});

// Tabs
function switchTab(tab) {
  document.getElementById('panelClip').classList.toggle('hidden', tab !== 'clip');
  document.getElementById('panelFiles').classList.toggle('hidden', tab !== 'files');
  document.getElementById('tabClip').classList.toggle('active', tab === 'clip');
  document.getElementById('tabFiles').classList.toggle('active', tab === 'files');
}

// File upload
let selectedFiles = [];
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const fileListEl = document.getElementById('fileList');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); addFiles([...e.dataTransfer.files]); });
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => addFiles([...fileInput.files]));

function addFiles(files) {
  selectedFiles = [...selectedFiles, ...files];
  renderFileList();
  uploadBtn.disabled = selectedFiles.length === 0;
}

function renderFileList() {
  if (!selectedFiles.length) { fileListEl.classList.add('hidden'); return; }
  fileListEl.classList.remove('hidden');
  fileListEl.innerHTML = selectedFiles.map((f, i) => `
    <div class="file-item">
      <span class="fname">${f.name}</span>
      <span class="fsize">${formatSize(f.size)}</span>
      <button class="btn-sm danger" onclick="removeFile(${i})">✕</button>
    </div>`).join('');
}

function removeFile(i) { selectedFiles.splice(i, 1); renderFileList(); uploadBtn.disabled = !selectedFiles.length; }

uploadBtn.addEventListener('click', async () => {
  if (!selectedFiles.length) return;
  uploadBtn.disabled = true;
  uploadBtn.textContent = 'uploading…';
  const fd = new FormData();
  selectedFiles.forEach(f => fd.append('files', f));
  fd.append('csrfmiddlewaretoken', getCookie('csrftoken'));
  const res = await fetch(`/b/${KEY}/upload/`, { method: 'POST', body: fd });
  if (res.ok) { window.location.href = `/b/${KEY}/key-file/`; setTimeout(() => window.location.reload(), 800); }
  else { const d = await res.json(); showToast(d.error || 'Upload failed.'); uploadBtn.disabled = false; uploadBtn.textContent = 'upload to this key'; }
});

async function deleteFile(id) {
  if (!confirm('Delete?')) return;
  const res = await fetch(`/b/${KEY}/file/${id}/delete/`, { method: 'DELETE', headers: {'X-CSRFToken': getCookie('csrftoken')} });
  if (res.ok) document.getElementById(`file-${id}`).remove();
}
</script>
{% endblock %}