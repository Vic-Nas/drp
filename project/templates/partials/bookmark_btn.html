{% if user.is_authenticated %}
{% load drop_tags %}
<div class="bookmark-btn-wrap" style="display:inline-block;margin-left:.5rem">
  {% if drop|is_saved_by:user %}
    <button class="btn-sm bookmark-btn bookmarked"
            data-ns="{{ ns }}"
            data-key="{{ key }}"
            data-saved="true">
      ğŸ”– saved
    </button>
  {% else %}
    <button class="btn-sm bookmark-btn"
            data-ns="{{ ns }}"
            data-key="{{ key }}"
            data-saved="false">
      ğŸ”– save
    </button>
  {% endif %}
</div>

<script>
document.querySelectorAll('.bookmark-btn').forEach(btn => {
  btn.addEventListener('click', async function () {
    const ns    = this.dataset.ns;
    const key   = this.dataset.key;
    const saved = this.dataset.saved === 'true';
    const base  = ns === 'f' ? `/f/${key}` : `/${key}`;
    const action = `${base}/${saved ? 'unsave' : 'save'}/`;

    const res = await fetch(action, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
    });

    if (res.ok) {
      this.dataset.saved = saved ? 'false' : 'true';
      this.textContent   = saved ? 'ğŸ”– save' : 'ğŸ”– saved';
      this.classList.toggle('bookmarked', !saved);
      showToast(saved ? 'removed from saved' : 'drop saved!');
    } else {
      const data = await res.json().catch(() => ({}));
      showToast(data.error || 'Something went wrong.');
    }
  });
});
</script>
{% endif %}