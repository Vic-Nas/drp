{# partials/bookmark_btn.html
   Include in clipboard_view.html and file_view.html.

   Required context:
     drop    â€” the Drop object
     ns      â€” 'c' or 'f'
     key     â€” the drop key

   Usage:
     {% include "partials/bookmark_btn.html" with drop=drop ns=drop.ns key=drop.key %}
#}
{% if user.is_authenticated %}
{% with is_saved=user.saved_drops.all|dictsort:"key" %}
{# We check server-side whether this drop is already saved. #}
{% load drop_tags %}
<div class="bookmark-btn-wrap" style="display:inline-block;margin-left:.5rem">
  {% if drop|is_saved_by:user %}
    <button class="btn-sm bookmark-btn bookmarked"
            data-ns="{{ ns }}"
            data-key="{{ key }}"
            data-saved="true">
      ðŸ”– saved
    </button>
  {% else %}
    <button class="btn-sm bookmark-btn"
            data-ns="{{ ns }}"
            data-key="{{ key }}"
            data-saved="false">
      ðŸ”– save
    </button>
  {% endif %}
</div>
{% endwith %}

<script>
document.querySelectorAll('.bookmark-btn').forEach(btn => {
  btn.addEventListener('click', async function () {
    const ns = this.dataset.ns;
    const key = this.dataset.key;
    const saved = this.dataset.saved === 'true';
    const action = ns === 'f' ? `/f/${key}/${saved ? 'unsave' : 'save'}/` : `/${key}/${saved ? 'unsave' : 'save'}/`;

    const res = await fetch(action, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
    });

    if (res.ok) {
      if (saved) {
        this.dataset.saved = 'false';
        this.textContent = 'ðŸ”– save';
        this.classList.remove('bookmarked');
      } else {
        this.dataset.saved = 'true';
        this.textContent = 'ðŸ”– saved';
        this.classList.add('bookmarked');
      }
    }
  });
});
</script>
{% endif %}